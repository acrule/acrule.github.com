<!DOCTYPE html>
<meta charset="utf-8">
<title>50 Days of License Plates</title>

<!--
Author: Adam Rule
Date: Oct 26, 2013
Inspiration and code drawn from:
http://bl.ocks.org/mbostock/4060606
http://bl.ocks.org/mbostock/2206590 
-->

<style>

body {
  width: 800px;
  font-family: "helvetica neue",helvetica,arial,sans-serif;
  margin: 0 auto;
}

h1 {
  font-size: 3em;
  color: #666;
}

p.caption {
  color: #aaa;
}

.background {
  fill: none;
  pointer-events: all;
  border-style: solid;
  border-width: 2px;
  border-color: #aaa;
}

.label {
	font: 500 5em "Helvetica Neue";
	fill: #666;
	stroke:#fff;
	stroke-width:1px;

}

.label .active {
	fill: #666;
}

.label .inactive{
	fill: #aaa;
}

.overlay {
  fill: none;
  pointer-events: all;
  cursor: ew-resize;
}

#states {
  fill: #aaa;
}

#states .active {
  fill: steelblue;
}

#states .inactive{
  fill: #aaa;
}

#state-borders {
  fill: none;
  stroke: #fff;
  stroke-width: 1.5px;
  stroke-linejoin: round;
  stroke-linecap: round;
  pointer-events: none;
}

</style>

<body>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>

<h1>50 Days of Liscence Plates</h1>

<script>

var width = 800,
    height = 500;

var projection = d3.geo.albersUsa()
    .scale(1070)
    .translate([width / 2, height / 2]);

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);
    
var g = svg.append("g");

var label = svg.append("text")
    .attr("class", "label")
    .attr("text-anchor", "end")
    .attr("y", height-8)
    .attr("x", width)
    .text("Total");

var button = g.append("button");

d3.json("us.json", function(error, json) {

	g.append("g")
		.attr("id", "states")
		.selectAll("path")
		.data(topojson.feature(json, json.objects.states).features)
    	.enter().append("path")
      	.attr("d", path)
      	.attr("class", function(d){return colorStates(d,0)});

  	g.append("path")
      	.datum(topojson.mesh(json, json.objects.states, function(a, b) { return a !== b; }))
      	.attr("id", "state-borders")
      	.attr("d", path);
	
	//Make interactive overlay for the date label
	var box = label.node().getBBox();

  	var overlay = svg.append("rect")
    	.attr("class", "overlay")
        .attr("x", box.x)
        .attr("y", box.y)
        .attr("width", box.width)
        .attr("height", box.height)
        .on("mouseover", enableInteraction);

	playTransition();

	function playTransition() {
		g.transition()
			.duration(25000)
			.ease("linear")
			.tween("date", tweenDate)
			.each("end", enableInteraction)
	}
        
    function tweenDate() {
    	var date = d3.interpolateRound(1, 50);
    	return function(t) { changeDate(date(t)); };
  	}
    
    function enableInteraction() {
    var dateScale = d3.scale.linear()
        .domain([0, 50])
        .range([box.x + 10, box.x + box.width - 10])
        .clamp(true);

    // Cancel the current transition, if any.
    g.transition().duration(0);

    overlay
        .on("mouseover", mouseover)
        .on("mouseout", mouseout)
        .on("mousemove", mousemove)
        .on("touchmove", mousemove);

    function mouseover() {
      label.attr("class", "label active");
    }

    function mouseout() {
      label.attr("class", "label inactive");
    }

    function mousemove() {
      changeDate(Math.round(dateScale.invert(d3.mouse(this)[0])));
    }
  }
	
	function colorStates(d,i){
		if(d.properties.seen[i]==1){ return "active" }
		else{ return "inactive" }
	}
	
	function changeDate(date){
		g.select("#states").selectAll("path")
		.attr("class", function(d){if(d.properties.seen[date]==1){return "active"}else{return "inactive"}});
		if(date==0){label.text("Total")}
		else if(date<6){date=date+26;label.text("Oct"+date.toString())}
		else if(date<36){date = date-5; label.text("Nov"+date.toString());}
		else {date=date-35; label.text("Dec"+date.toString());}
	}
});

</script>

<p class="caption">Liscence plates seen on cars in San Diego, CA between October 27 - December 15, 2013.</p>